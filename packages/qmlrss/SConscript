Import('penv')

package = {
    'requires': ['qt'],
    'sysroot_debs': [],
    'root_debs': [],
    'target': File('qmlrss.tar.gz'),
    'install': ['${CHROOT} ${STAGE} /bin/systemctl reenable qmlrss.service'],
}

prefix = '/opt/qt'
stage = Dir('stage/')

repo = Dir('qmlrss/')

penv.Command([package['target']], ['qmlrss.service', *list(penv['FUNCTIONS'].repo_scan(repo))], [

    'rm -rf --one-file-system ${STAGE}',

    'cd ${REPO} && ${QMAKE}',
    'make -j8 -C ${REPO}',

    'mkdir -p ${STAGE}/etc/systemd/system',
    'mkdir -p ${STAGE}/${PREFIX}/bin',

    'cp ${SOURCES[0]} ${STAGE}/etc/systemd/system/',
    'cp ${REPO}/qmlrss ${STAGE}/${PREFIX}/bin/',

    'tar -C ${STAGE} -czf ${TARGETS[0]} .',

], PREFIX=prefix, STAGE=stage, REPO=repo)

Return('package')
