import itertools

Import('penv')

package = {

    'requires': [],

    'sysroot_debs': [
        'libfontconfig1-dev', 'libmtdev-dev', 'libudev-dev', 'libts-dev', 'flex', 'freetds-dev',
        'libasound2-dev', 'libaudio-dev', 'libdbus-1-dev', 'libfreetype6-dev', 'libglib2.0-dev',
        'libjpeg-dev', 'libmng-dev', 'libpam0g-dev', 'libpng-dev', 'libreadline-dev', 'libssl1.0-dev',
        'libtiff-dev', 'zlib1g-dev', 'libjpeg-dev', 'libraspberrypi-dev',
    ],

    'root_debs': [
        'libraspberrypi0', 'libpng12-0', 'libglib2.0-0', 'libmtdev1', 'libts-0.0-0', 'libfontconfig1',
        'libfreetype6', 'libssl1.0.2', 'libjpeg62-turbo',
    ],

    'target': File('qt.tar.gz'),
    'install': [],

}

repos = [Dir(d) for d in ['qtbase/', 'qtxmlpatterns/', 'qtdeclarative/']]

prefix = '/opt/qt'
stage = Dir('stage/')

penv['QT_HOST'] = Dir('qt-host')
penv['QMAKE'] = penv['QT_HOST'].File('bin/qmake')

penv.Command([package['target'], '${QMAKE}'], ['${SYSROOT}', *list(penv['FUNCTIONS'].repo_scan(*repos))], [

    'rm -rf --one-file-system ${STAGE} ${QT_HOST}',
    'for repo in ${REPOS}; do git -C $$repo clean -dfxq; done',

    '/bin/sh',

    'cd ${REPOS[0]} && ./configure -release -opengl es2 -device linux-rasp-pi2-g++ \
		-qpa eglfs -no-libinput -no-linuxfb -no-xcb -no-kms -no-gbm \
		-no-gtk -no-widgets -no-compile-examples -no-sql-tds \
		-device-option CROSS_COMPILE=${CROSS_COMPILE} -sysroot ${SYSROOT.abspath} \
		-opensource -confirm-license -make libs -strip -optimize-size \
		-prefix ${PREFIX} -extprefix ${STAGE.abspath}/${PREFIX} -hostprefix ${QT_HOST.abspath} 2>&1 ${REDIRECT}',

    '${MAKE} -C ${REPOS[0]} ${REDIRECT}',
    '${MAKE} -C ${REPOS[0]} install ${REDIRECT}',

    'cd ${REPOS[1]} && ${QMAKE.abspath} ${REDIRECT}',
    '${MAKE} -C ${REPOS[1]} ${REDIRECT}',
    '${MAKE} -C ${REPOS[1]} install ${REDIRECT}',

    'cd ${REPOS[2]} && ${QMAKE.abspath} ${REDIRECT}',
    '${MAKE} -C ${REPOS[2]} ${REDIRECT}',
    '${MAKE} -C ${REPOS[2]} install ${REDIRECT}',

    'mkdir -p ${STAGE}/etc/ld.so.conf.d',
    'echo ${PREFIX}/lib > ${STAGE}/etc/ld.so.conf.d/opt-qt.conf',

    'tar -C ${STAGE} --exclude=.${PREFIX}/doc --exclude=.${PREFIX}/include \
        --exclude=.${PREFIX}/lib/cmake --exclude=.${PREFIX}/lib/pkgconfig \
        -czf ${TARGETS[0]} .'

], REPOS=repos, PREFIX=prefix, STAGE=stage)

Return('package')
