packages = []

for p in Glob('../packages/*/SConscript'):
    packages.append(SConscript(p))

def conf_for_package(p):
    return """
    # packages for {:s}
    packages={:s}
    """.format('unknown', ' '.join(p['sysroot_debs']))


def relative_links(root):

    root = pathlib.Path(root).resolve()

    for path in pathlib.Path(root).rglob('**'):
        if path.is_symlink():
            target = os.readlink(str(path))
            if target[0] != '/':
                continue
            if target.startswith(str(root)):
                continue
            path.unlink()
            os.symlink(str(path.relative_to(root)), str(path))


env = Environment(tools=[])
env.Tool('textfile')

multistrap_conf = Value("""
    [General]
    arch=armhf
    aptsources=
    bootstrap=Raspbian Foundation
    omitrequired=true
    addimportant=false
    allowrecommends=false

    [Raspbian]
    source=http://mirrordirector.raspbian.org/raspbian
    suite=stretch

    [Foundation]
    source=http://archive.raspberrypi.org/debian
    suite=stretch
    packages=build-essential

    {:s}
    """.format(' '.join(conf_for_package(p) for p in packages if p['enabled'])))

multistrap_conf_file = env.Textfile('multistrap.conf', multistrap_conf)

toolchain = Dir('toolchain/')
sysroot = Dir('sysroot/')

Command(sysroot, multistrap_conf_file, [
    'mkdir -p $TARGET/etc/apt/trusted.gpg.d/',
    'gpg --export 82B129927FA3303E > $TARGET/etc/apt/trusted.gpg.d/raspberrypi-archive-keyring.gpg',
	'gpg --export 9165938D90FDDD2E > $TARGET/etc/apt/trusted.gpg.d/raspbian-archive-keyring.gpg',
    '/usr/sbin/multistrap -d $TARGET -f $SOURCE',
    # TODO: call relative_links on $TARGET
])

toolchain = Dir('toolchain/')
toolchain_tarball = File('gcc-linaro-6.3.1-2017.05-x86_64_arm-linux-gnueabihf.tar.xz')

Command(toolchain_tarball, None, [
    'wget -N -O $TARGET https://releases.linaro.org/components/toolchain/binaries/6.3-2017.05/arm-linux-gnueabihf/gcc-linaro-6.3.1-2017.05-x86_64_arm-linux-gnueabihf.tar.xz'
])

Command(toolchain, toolchain_tarball, [
    'mkdir -p $TARGET',
    'tar -C $TARGET --strip-components=1 -xf $SOURCE',
])
